<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visitors</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.19.4/dist/css/uikit.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.19.4/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    .chart-card { border-radius: 16px; overflow: hidden; padding: 10px; margin: 10px 0; }
    #wrap { max-width: 920px; margin: 20px auto; }
  </style>
</head>
<body>
  <div id="wrap" class="uk-container">
    <div class="uk-card uk-card-default uk-card-body chart-card">
      <!--h3 class="uk-card-title uk-margin-remove">Visitors</h3-->
      <canvas id="visitorsChart" height="160"></canvas>
      <!--p class="uk-text-meta uk-margin-small-top">Data source: <code>/data/visitors.csv</code> with headers <code>date,visitors</code> (or <code>date,count</code>).</p-->
    </div>
  </div>

  <script>
  async function loadCsv(path) {
    const url = new URL(path, window.location.href).href;
    const resp = await fetch(url, { cache: 'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status} for ${url}`);

    const text = (await resp.text()).trim();
    if (!text) throw new Error(`CSV/TSV empty at ${url}`);

    let lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

    // Split by tab OR comma (your file is TSV)
    const split = (s) => s.split(/[\t,]/).map(x => x.trim());

    // Remove any header lines that appear anywhere (you have them at the bottom, twice)
    const isHeaderRow = (cols) => {
      const c = cols.map(x => x.toLowerCase());
      return c[0] === 'date' && (c[1] === 'visitors' || c[1] === 'count') && c[2] === 'uniques';
    };

    // Parse rows; keep only valid data rows (YYYY-MM-DD ...)
    const rows = lines
      .map(split)
      .filter(cols => cols.length >= 2)
      .filter(cols => !isHeaderRow(cols))
      .filter(cols => /^\d{4}-\d{2}-\d{2}$/.test(cols[0])); // date in first column

    if (!rows.length) throw new Error(`No valid data rows parsed from ${url}`);

    // Map columns: date, visitors, uniques
    const items = rows
      .map(cols => ({
        d: cols[0],
        visitors: Number(cols[1]),
        uniques: cols.length >= 3 ? Number(cols[2]) : NaN
      }))
      .filter(p => p.d && Number.isFinite(p.visitors))
      .sort((a, b) => a.d.localeCompare(b.d));

    return items;
  }

  function drawChart(items) {
    const labels = items.map(p => p.d);
    const data = items.map(p => p.visitors); // <- switch to p.uniques if you want uniques

    const ctx = document.getElementById('visitorsChart');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Visitors',
          data,
          tension: 0,
          fill: false,
          pointRadius: 2,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        animation: false,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: true, title: { display: true, text: '# of Visitors' } }
        }
      }
    });
  }

  (async () => {
    try {
      const items = await loadCsv('https://raw.githubusercontent.com/hz658832/RobotMeetsGNSS/main/data/visitors.csv');
      drawChart(items);
    } catch (e) {
      console.error(e);
      const el = document.getElementById('visitorsChart').parentElement;
      el.insertAdjacentHTML('beforeend',
        `<div class="uk-alert-danger" uk-alert><p>${e.message}</p></div>`);
    }
  })();
</script>

</body>
</html>
